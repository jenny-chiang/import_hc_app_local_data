name: 'Delete Merged Branch'

on:
  pull_request:
    types: [closed]

jobs:
  delete-branch:
    # 只在 PR 被 merge 時執行
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要 write 權限才能刪除分支
    steps:
      - name: Delete merged branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"

          # 定義受保護的分支清單
          PROTECTED_BRANCHES=("main")

          # 檢查是否為受保護的分支
          for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [ "$BRANCH_NAME" == "$protected" ]; then
              echo "⚠️  分支 $BRANCH_NAME 是受保護的分支，跳過刪除"
              exit 0
            fi
          done

          # 刪除分支
          gh api \
            --method DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/git/refs/heads/$BRANCH_NAME"

          echo "✅ 成功刪除分支: $BRANCH_NAME"
        env:
          GH_TOKEN: ${{ github.token }}
